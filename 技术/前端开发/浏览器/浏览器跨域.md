---
aliases: [同源策略网络, 浏览器跨域]
tags: [浏览器跨域]
date created: 2022-06-20 21:17:45
date updated: 2022-12-29 16:12:45
title: 同源策略网络
---

# 浏览器跨域

## 同源策略网络

| 说明           | 是否允许通讯 |
| ------------ | ------ |
| 同一域名，不同文件或路径 | 允许     |
| 同一域名，不同端口    | 不允许    |
| 同一域名，不同协议    | 不允许    |
| 域名和域名对应 ip   | 不允许    |
| 域相同，子域不同     | 不允许    |
| 不同域名         | 不允许    |

## 跨域通信方式

### JSONP

JSONP 是 JSON with Padding 的缩写，它是一种跨域通信的方式。JSONP 的原理是利用 `<script>` 标签没有跨域限制的漏洞，通过 `<script>` 标签指向一个需要访问的地址并提供一个回调函数来接收数据。

```html
// index.html
<script>
  function callback(data) {
    console.log(data);
  }
</script>
<script src="http://localhost:3000/api?callback=callback"></script>
```

```ts
// server.ts
import express from 'express';

const app = express();

app.get('/api', (req, res) => {
  const { callback } = req.query;
  res.send(`${callback}({ name: 'JSONP' })`);
});

app.listen(3000, () => {
  console.log('server is running at http://localhost:3000');
});
```

### CORS

CORS 是 Cross-Origin Resource Sharing 的缩写，它是一种跨域资源共享的方式。CORS 的原理是利用浏览器的同源策略，只要服务器设置了正确的 CORS 响应头，浏览器就会允许跨域请求。

- W3C 标准，它允许浏览器像跨域的服务器发送 AJAX 请求，兼容浏览器 IE10+
- 需要满足下列条件：
  - 使用下列请求方式之一
    - `GET`
    - `POST`
    - `HEAD`
  - `Content-Type` 的值仅限于下列三者之一：
    - `text/plain`
    - `multipart/form-data`
    - `application/x-www-form-urlencoded`
  - 请求中的任意 `XMLHttpRequestUpload` 对象均没有注册任何事件监听器；`XMLHttpRequestUpload` 对象可以使用 `XMLHttpRequest.upload` 属性访问。
  - 请求中没有使用 `ReadableStream` 对象。
  - Fetch 规范定义了 [对 CORS 安全的首部字段集合](https://fetch.spec.whatwg.org/[[cors-safelisted-request-header]]) ，不得人为设置该集合之外的其他首部字段。该集合为：
    - `Accept`
    - `Accept-Language`
    - `Content-Language`
    - `Content-Type` （需要注意额外的限制）
    - `DPR`
    - `Downlink`
    - `Save-Data`
    - `Viewport-Width`
    - `Width`
